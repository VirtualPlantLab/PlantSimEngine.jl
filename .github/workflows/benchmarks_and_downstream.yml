name: Benchmarks
on:
  push:
    branches:
      - main
      - Outputs-filtering2
      - PSE-multiscale-outputs-structure-change
    tags: "*"
  pull_request:
  workflow_dispatch:
permissions:
  # deployments permission to deploy GitHub pages website
    deployments: write
  # contents permission to update benchmark contents in gh-pages branch
    contents: write
jobs:
  test:
    name: Julia ${{ matrix.version }} - ${{ matrix.os }} - ${{ matrix.arch }} - ${{ github.event_name }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        version:
          - "1"
        os:
          - ubuntu-latest
          - macOS-latest
          - windows-latest
        arch:
          - x64
        package:
        - {user: PalmStudio, repo: XPalm.jl, branch: PSE-multiscale-outputs-structure-change}
        - {user: VEZY, repo: PlantBioPhysics.jl, branch: PSE-multiscale-outputs-structure-change}
    steps:
      - uses: actions/checkout@v4
      - uses: julia-actions/setup-julia@v2
        with:
          version: ${{ matrix.version }}
          arch: ${{ matrix.arch }}
      - uses: julia-actions/julia-buildpkg@v1
      - name: Clone Downstream
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.package.user }}/${{ matrix.package.repo }}
          ref: ${{matrix.package.branch}}
          path: downstream
      # TODO handle breaking changes the way downstream tests do ?
      # NOTE : manifest toml file is removed otherwise git whines about untracked changes when switching branches for the gh-pages commit
      - name: Run benchmarks
        run: |
          cd test/downstream
          julia --project --threads 4 --color=yes -e '
            using Pkg;
            Pkg.instantiate();
            include("test-all-benchmarks.jl")'
          rm Manifest.toml
      - name: Store benchmark result
        uses: benchmark-action/github-action-benchmark@v1
        with:
          name: Julia benchmark result
          tool: 'julia'
          output-file-path: ${{ github.workspace }}/test/downstream/output.json
          # Use personal access token instead of GITHUB_TOKEN due to https://github.community/t/github-action-not-triggering-gh-pages-upon-push/16096
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: true
          # Show alert with commit comment on detecting possible performance regression
          alert-threshold: '130%'
          comment-on-alert: true
          fail-on-alert: true
          alert-comment-cc-users: '@Samuel-AMAP, @VEZY'
     
      - uses: julia-actions/julia-processcoverage@v1
      - uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: lcov.info
          fail_ci_if_error: false
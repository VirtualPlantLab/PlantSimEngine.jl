<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Modelers · PlantSimEngine.jl</title><meta name="title" content="Modelers · PlantSimEngine.jl"/><meta property="og:title" content="Modelers · PlantSimEngine.jl"/><meta property="twitter:title" content="Modelers · PlantSimEngine.jl"/><meta name="description" content="Documentation for PlantSimEngine.jl."/><meta property="og:description" content="Documentation for PlantSimEngine.jl."/><meta property="twitter:description" content="Documentation for PlantSimEngine.jl."/><meta property="og:url" content="https://VirtualPlantLab.github.io/PlantSimEngine.jl/model_coupling/model_coupling_modeler/"/><meta property="twitter:url" content="https://VirtualPlantLab.github.io/PlantSimEngine.jl/model_coupling/model_coupling_modeler/"/><link rel="canonical" href="https://VirtualPlantLab.github.io/PlantSimEngine.jl/model_coupling/model_coupling_modeler/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">PlantSimEngine.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../design/">Design</a></li><li><a class="tocitem" href="../../model_switching/">Model Switching</a></li><li><a class="tocitem" href="../../reducing_dof/">Reducing DoF</a></li><li><a class="tocitem" href="../../model_execution/">Execution</a></li><li><a class="tocitem" href="../../fitting/">Fitting</a></li><li><span class="tocitem">Extending</span><ul><li><a class="tocitem" href="../../extending/implement_a_process/">Processes</a></li><li><a class="tocitem" href="../../extending/implement_a_model/">Models</a></li><li><a class="tocitem" href="../../extending/inputs/">Input types</a></li></ul></li><li><span class="tocitem">Coupling</span><ul><li><input class="collapse-toggle" id="menuitem-8-1" type="checkbox"/><label class="tocitem" for="menuitem-8-1"><span class="docs-label">Users</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../model_coupling_user/">Simple case</a></li><li><a class="tocitem" href="../multiscale/">Multi-scale modelling</a></li></ul></li><li class="is-active"><a class="tocitem" href>Modelers</a><ul class="internal"><li><a class="tocitem" href="#Hard-coupling"><span>Hard coupling</span></a></li><li><a class="tocitem" href="#Soft-coupling"><span>Soft coupling</span></a></li><li><a class="tocitem" href="#Handling-dependencies-in-a-multiscale-context"><span>Handling dependencies in a multiscale context</span></a></li></ul></li><li><a class="tocitem" href="../tips_and_workarounds/">Tips and Workarounds</a></li></ul></li><li><span class="tocitem">FAQ</span><ul><li><a class="tocitem" href="../../FAQ/translate_a_model/">I want to use PlantSimEngine for my model</a></li></ul></li><li><a class="tocitem" href="../../API/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Coupling</a></li><li class="is-active"><a href>Modelers</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Modelers</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/VirtualPlantLab/PlantSimEngine.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/VirtualPlantLab/PlantSimEngine.jl/blob/main/docs/src/model_coupling/model_coupling_modeler.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Model-coupling-for-modelers"><a class="docs-heading-anchor" href="#Model-coupling-for-modelers">Model coupling for modelers</a><a id="Model-coupling-for-modelers-1"></a><a class="docs-heading-anchor-permalink" href="#Model-coupling-for-modelers" title="Permalink"></a></h1><p>This section uses notions from the previous section. If you are not familiar with the concepts of model coupling in PlantSimEngine, please read the previous section first: <a href="../model_coupling_user/#Model-coupling-for-users">Model coupling for users</a>.</p><h2 id="Hard-coupling"><a class="docs-heading-anchor" href="#Hard-coupling">Hard coupling</a><a id="Hard-coupling-1"></a><a class="docs-heading-anchor-permalink" href="#Hard-coupling" title="Permalink"></a></h2><p>A model that calls explicitly another process is called a hard-coupled model. It is implemented by calling the process function directly.</p><p>Let&#39;s go through the example processes and models from a script provided by the package here <a href="https://github.com/VirtualPlantLab/PlantSimEngine.jl/blob/main/examples/dummy.jl">examples/dummy.jl</a></p><p>In this script, we declare seven processes and seven models, one for each process. The processes are simply called &quot;process1&quot;, &quot;process2&quot;..., and the model implementations are called <code>Process1Model</code>, <code>Process2Model</code>...</p><p><code>Process2Model</code> calls <code>Process1Model</code> explicitly, which defines <code>Process1Model</code> as a hard-dependency of <code>Process2Model</code>. The is as follows:</p><pre><code class="language-julia hljs">function PlantSimEngine.run!(::Process2Model, models, status, meteo, constants, extra)
    # computing var3 using process1:
    run!(models.process1, models, status, meteo, constants)
    # computing var4 and var5:
    status.var4 = status.var3 * 2.0
    status.var5 = status.var4 + 1.0 * meteo.T + 2.0 * meteo.Wind + 3.0 * meteo.Rh
end</code></pre><p>We see that coupling a model (<code>Process2Model</code>) to another process (<code>process1</code>) is done by calling the <code>run!</code> function again. The <code>run!</code> function is called with the same arguments as the <code>run!</code> function of the model that calls it, except that we pass the process we want to simulate as the first argument.</p><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>We don&#39;t enforce any type of model to simulate <code>process1</code>. This is the reason why we can switch so easily between model implementations for any process, by just changing the model in the <code>ModelList</code>.</p></div></div><p>A hard-dependency must always be declared to PlantSimEngine. This is done by adding a method to the <code>dep</code> function. For example, the hard-dependency to <code>process1</code> into <code>Process2Model</code> is declared as follows:</p><pre><code class="language-julia hljs">PlantSimEngine.dep(::Process2Model) = (process1=AbstractProcess1Model,)</code></pre><p>This way PlantSimEngine knows that <code>Process2Model</code> needs a model for the simulation of the <code>process1</code> process. Note that we don&#39;t add any constraint to the type of model we have to use (we use <code>AbstractProcess1Model</code>), because we want any model implementation to work with the coupling, as we only are interested in the value of a variable, not the way it is computed.</p><p>Even if it is discouraged, you may have a valid reason to force the coupling with a particular model, or a kind of models though. For example, if we want to use only <code>Process1Model</code> for the simulation of <code>process1</code>, we would declare the dependency as follows:</p><pre><code class="language-julia hljs">PlantSimEngine.dep(::Process2Model) = (process1=Process1Model,)</code></pre><h2 id="Soft-coupling"><a class="docs-heading-anchor" href="#Soft-coupling">Soft coupling</a><a id="Soft-coupling-1"></a><a class="docs-heading-anchor-permalink" href="#Soft-coupling" title="Permalink"></a></h2><p>A model that takes outputs of another model as inputs is called a soft-coupled model. There is nothing to do on the modeler side to declare a soft-dependency. The detection is done automatically by PlantSimEngine using the inputs and outputs of the models.</p><h2 id="Handling-dependencies-in-a-multiscale-context"><a class="docs-heading-anchor" href="#Handling-dependencies-in-a-multiscale-context">Handling dependencies in a multiscale context</a><a id="Handling-dependencies-in-a-multiscale-context-1"></a><a class="docs-heading-anchor-permalink" href="#Handling-dependencies-in-a-multiscale-context" title="Permalink"></a></h2><p>If a model requires some input variable that is computed at another scale, providing the appropriate mapping will resolve name conflicts and enable proper use of that variable and there will be no extra steps for the user or the modeler.</p><p>In the case of a hard dependency that operates at a different scale from its parent, the same principle applies and there are also no extra steps on the user-side. </p><p>On the other hand, modelers need to bear in mind a couple of subtleties when developing models that possess hard dependencies that operate at a different organ level from their parent : </p><p>The parent model directly handles the call to its hard dependency model(s), meaning they are not explicitely managed by the dependency graph.  Therefore only the owning model of that dependency is visible in the graph, and its hard dependency nodes are internal.</p><p>When the caller (or any downstream model that requires some variables from the hard dependency) operates at the same scale, variables are easily accessible, and no mapping is required. </p><p>If an inner model operates at a different scale/organ level, a modeler must declare hard dependencies with their respective organ level, similarly to the way the user provides a mapping. </p><p>Conceptually :</p><pre><code class="language-julia hljs"> PlantSimEngine.dep(m::ParentModel) = (
    name_provided_in_the_mapping=AbstractHardDependencyModel =&gt; [&quot;Organ_Name_1&quot;,],
)</code></pre><p>Here&#39;s a concrete example in <a href="https://github.com/PalmStudio/XPalm.jl">XPalm</a>, an oil palm model developed on top of PlantSimEngine.   Organs are produced at the phytomer scale, but need to run an age model and a biomass model at the reproductive organs&#39; scales.</p><pre><code class="language-julia hljs"> PlantSimEngine.dep(m::ReproductiveOrganEmission) = (
    initiation_age=AbstractInitiation_AgeModel =&gt; [m.male_symbol, m.female_symbol],
    final_potential_biomass=AbstractFinal_Potential_BiomassModel =&gt; [m.male_symbol, m.female_symbol],
)</code></pre><p>The user-mapping includes the required models at specific organ levels. Here&#39;s the relevant portion of the mapping for the male reproductive organ :</p><pre><code class="language-julia hljs">mapping = Dict(
    ...
    &quot;Male&quot; =&gt;
    MultiScaleModel(
        model=XPalm.InitiationAgeFromPlantAge(),
        mapping=[:plant_age =&gt; &quot;Plant&quot;,],
    ),
    ...
    XPalm.MaleFinalPotentialBiomass(
        p.parameters[:male][:male_max_biomass],
        p.parameters[:male][:age_mature_male],
        p.parameters[:male][:fraction_biomass_first_male],
    ),
    ...
)</code></pre><p>The model&#39;s constructor provides convenient default names for the scale corresponding to the reproductive organs. A user may override that if their naming schemes or MTG attributes differ.</p><pre><code class="language-julia hljs">function ReproductiveOrganEmission(mtg::MultiScaleTreeGraph.Node; phytomer_symbol=&quot;Phytomer&quot;, male_symbol=&quot;Male&quot;, female_symbol=&quot;Female&quot;)
    ...
end</code></pre><p>But how does a model M calling a hard dependency H provide H&#39;s variables when calling H&#39;s <code>run!</code> function ? The status the user provides M operates at M&#39;s organ level, so if used to call H&#39;s run! function any required variable for H will be missing.    </p><p>PlantSimEngine provides what are called Status Templates in the simulation graph. Each organ level has its own Status template listing the available variables at that scale. So when a model M calls a hard dependency H&#39;s <code>run!</code> function, any required variables can be accessed through the status template of H&#39;s organ level.</p><p>Using the same example in XPalm : </p><pre><code class="language-julia hljs"># Note that the function&#39;s &#39;status&#39; parameter does NOT contain the variables required by the hard dependencies as the calling model&#39;s organ level is &quot;Phytomer&quot;, not &quot;Male&quot; or &quot;Female&quot;

function PlantSimEngine.run!(m::ReproductiveOrganEmission, models, status, meteo, constants, sim_object)
    ...
    status.graph_node_count += 1

    # Create the new organ as a child of the phytomer:
    st_repro_organ = add_organ!(
        status.node[1], # The phytomer&#39;s internode is its first child 
        sim_object,  # The simulation object, so we can add the new status 
        &quot;+&quot;, status.sex, 4;
        index=status.phytomer_count,
        id=status.graph_node_count,
        attributes=Dict{Symbol,Any}()
    )

    # Compute the initiation age of the organ:
    PlantSimEngine.run!(sim_object.models[status.sex].initiation_age, sim_object.models[status.sex], st_repro_organ, meteo, constants, sim_object)
    PlantSimEngine.run!(sim_object.models[status.sex].final_potential_biomass, sim_object.models[status.sex], st_repro_organ, meteo, constants, sim_object)
end</code></pre><p>In the above example the organ and its status template are created on the fly. When that isn&#39;t the case, the status template can be accessed through the simulation graph :</p><pre><code class="language-julia hljs">function PlantSimEngine.run!(m::ReproductiveOrganEmission, models, status, meteo, constants, sim_object)

    ...

    if status.sex == &quot;Male&quot;

        status_male = sim_object.statuses[&quot;Male&quot;][1]
        run!(sim_object.models[&quot;Male&quot;].initiation_age, models, status_male, meteo, constants, sim_object)
        run!(sim_object.models[&quot;Male&quot;].final_potential_biomass, models, status_male, meteo, constants, sim_object)
    else
        # Female
        ...
    end
end</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../multiscale/">« Multi-scale modelling</a><a class="docs-footer-nextpage" href="../tips_and_workarounds/">Tips and Workarounds »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.0 on <span class="colophon-date" title="Tuesday 28 January 2025 16:02">Tuesday 28 January 2025</span>. Using Julia version 1.11.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>

<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Converting a simulation to multi-scale · PlantSimEngine.jl</title><meta name="title" content="Converting a simulation to multi-scale · PlantSimEngine.jl"/><meta property="og:title" content="Converting a simulation to multi-scale · PlantSimEngine.jl"/><meta property="twitter:title" content="Converting a simulation to multi-scale · PlantSimEngine.jl"/><meta name="description" content="Documentation for PlantSimEngine.jl."/><meta property="og:description" content="Documentation for PlantSimEngine.jl."/><meta property="twitter:description" content="Documentation for PlantSimEngine.jl."/><meta property="og:url" content="https://VirtualPlantLab.github.io/PlantSimEngine.jl/multiscale/single_to_multiscale/"/><meta property="twitter:url" content="https://VirtualPlantLab.github.io/PlantSimEngine.jl/multiscale/single_to_multiscale/"/><link rel="canonical" href="https://VirtualPlantLab.github.io/PlantSimEngine.jl/multiscale/single_to_multiscale/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">PlantSimEngine.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Introduction</span><ul><li><a class="tocitem" href="../../introduction/why_plantsimengine/">Why PlantSimEngine ?</a></li><li><a class="tocitem" href="../../introduction/why_julia/">Why Julia ?</a></li></ul></li><li><span class="tocitem">Prerequisites</span><ul><li><a class="tocitem" href="../../prerequisites/installing_plantsimengine/">Installing and running PlantSimEngine</a></li><li><a class="tocitem" href="../../prerequisites/key_concepts/">Key Concepts</a></li><li><a class="tocitem" href="../../prerequisites/julia_basics/">Julia language basics</a></li></ul></li><li><span class="tocitem">Step by step - Single-scale simulations</span><ul><li><a class="tocitem" href="../../step_by_step/detailed_first_example/">Detailed first simulation</a></li><li><a class="tocitem" href="../../step_by_step/simple_model_coupling/">Coupling</a></li><li><a class="tocitem" href="../../step_by_step/model_switching/">Model Switching</a></li><li><a class="tocitem" href="../../step_by_step/quick_and_dirty_examples/">Quick examples</a></li><li><a class="tocitem" href="../../step_by_step/implement_a_process/">Implementing a process</a></li><li><a class="tocitem" href="../../step_by_step/implement_a_model/">Implementing a model</a></li><li><a class="tocitem" href="../../step_by_step/parallelization/">Parallelization</a></li><li><a class="tocitem" href="../../step_by_step/advanced_coupling/">Advanced coupling and hard dependencies</a></li><li><a class="tocitem" href="../../step_by_step/implement_a_model_additional/">Implementing a model : additional notes</a></li></ul></li><li><a class="tocitem" href="../../model_execution/">Execution</a></li><li><span class="tocitem">Working with data</span><ul><li><a class="tocitem" href="../../working_with_data/reducing_dof/">Reducing DoF</a></li><li><a class="tocitem" href="../../working_with_data/fitting/">Fitting</a></li><li><a class="tocitem" href="../../working_with_data/inputs/">Input types</a></li><li><a class="tocitem" href="../../working_with_data/visualising_outputs/">Visualizing outputs and data</a></li><li><a class="tocitem" href="../../working_with_data/floating_point_accumulation_error/">Floating-point considerations</a></li></ul></li><li><span class="tocitem">Moving to multiscale</span><ul><li><a class="tocitem" href="../multiscale_considerations/">Multiscale considerations</a></li><li class="is-active"><a class="tocitem" href>Converting a simulation to multi-scale</a><ul class="internal"><li class="toplevel"><a class="tocitem" href="#Converting-the-ModelList-to-a-multi-scale-mapping"><span>Converting the ModelList to a multi-scale mapping</span></a></li><li><a class="tocitem" href="#Adding-a-new-package-for-our-plant-graph"><span>Adding a new package for our plant graph</span></a></li><li><a class="tocitem" href="#Running-the-multi-scale-simulation-?"><span>Running the multi-scale simulation ?</span></a></li><li><a class="tocitem" href="#Adding-a-second-scale"><span>Adding a second scale</span></a></li><li><a class="tocitem" href="#ToyDegreeDaysCumulModel"><span>ToyDegreeDaysCumulModel</span></a></li></ul></li><li><a class="tocitem" href="../multiscale/">More variable mapping examples</a></li><li><a class="tocitem" href="../multiscale_cyclic/">Handling cyclic dependencies</a></li><li><a class="tocitem" href="../multiscale_coupling/">Multiscale coupling considerations</a></li><li><input class="collapse-toggle" id="menuitem-7-6" type="checkbox"/><label class="tocitem" for="menuitem-7-6"><span class="docs-label">Building a simple plant</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../multiscale_example_1/">A rudimentary plant simulation</a></li><li><a class="tocitem" href="../multiscale_example_2/">Expanding the plant simulation</a></li><li><a class="tocitem" href="../multiscale_example_3/">Fixing bugs in the plant simulation</a></li></ul></li><li><a class="tocitem" href="../multiscale_example_4/">Visualizing our toy plant with PlantGeom</a></li></ul></li><li><span class="tocitem">Troubleshooting and testing</span><ul><li><a class="tocitem" href="../../troubleshooting_and_testing/plantsimengine_and_julia_troubleshooting/">Troubleshooting</a></li><li><a class="tocitem" href="../../troubleshooting_and_testing/downstream_tests/">Automated testing</a></li><li><a class="tocitem" href="../../troubleshooting_and_testing/tips_and_workarounds/">Tips and Workarounds</a></li><li><a class="tocitem" href="../../troubleshooting_and_testing/implicit_contracts/">Implicit contracts</a></li></ul></li><li><span class="tocitem">API</span><ul><li><a class="tocitem" href="../../API/API_public/">Public API</a></li><li><a class="tocitem" href="../../API/API_examples/">Example models</a></li><li><a class="tocitem" href="../../API/API_private/">Internal API</a></li></ul></li><li><a class="tocitem" href="../../documentation_improvement/">Improving our documentation</a></li><li><a class="tocitem" href="../../developers/">Developer guidelines</a></li><li><a class="tocitem" href="../../planned_features/">Planned features</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Moving to multiscale</a></li><li class="is-active"><a href>Converting a simulation to multi-scale</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Converting a simulation to multi-scale</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/VirtualPlantLab/PlantSimEngine.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/VirtualPlantLab/PlantSimEngine.jl/blob/main/docs/src/multiscale/single_to_multiscale.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Converting-a-single-scale-simulation-to-multi-scale"><a class="docs-heading-anchor" href="#Converting-a-single-scale-simulation-to-multi-scale">Converting a single-scale simulation to multi-scale</a><a id="Converting-a-single-scale-simulation-to-multi-scale-1"></a><a class="docs-heading-anchor-permalink" href="#Converting-a-single-scale-simulation-to-multi-scale" title="Permalink"></a></h1><p>A single-scale simulation can be turned into a &#39;pseudo-multi-scale&#39; simulation by providing a simple multi-scale tree graph, and declaring a mapping linking all models to a unique scale level.</p><p>This page showcases how to do the conversion, and then adds a model at a new scale to make the simulation genuinely multi-scale.</p><p>The full script for the example can be found in the examples folder, <a href="https://github.com/VirtualPlantLab/PlantSimEngine.jl/blob/main/examples/ToySingleToMultiScale.jl">here</a></p><ul><li><a href="#Converting-a-single-scale-simulation-to-multi-scale">Converting a single-scale simulation to multi-scale</a></li><li><a href="#Converting-the-ModelList-to-a-multi-scale-mapping">Converting the ModelList to a multi-scale mapping</a></li><li class="no-marker"><ul><li><a href="#Adding-a-new-package-for-our-plant-graph">Adding a new package for our plant graph</a></li><li><a href="#Running-the-multi-scale-simulation-?">Running the multi-scale simulation ?</a></li><li><a href="#Adding-a-second-scale">Adding a second scale</a></li><li class="no-marker"><ul><li><a href="#TT_cu-model-implementation">TT_cu model implementation</a></li><li><a href="#Linking-the-new-TT_cu-model-to-a-scale-in-the-mapping">Linking the new TT_cu model to a scale in the mapping</a></li><li><a href="#Mapping-between-scales-:-the-MultiScaleModel-wrapper">Mapping between scales : the MultiScaleModel wrapper</a></li><li><a href="#Running-the-multi-scale-simulation">Running the multi-scale simulation</a></li><li><a href="#Comparing-outputs-between-single-and-multi-scale">Comparing outputs between single- and multi-scale</a></li></ul></li><li><a href="#ToyDegreeDaysCumulModel">ToyDegreeDaysCumulModel</a></li></ul></li></ul><h1 id="Converting-the-ModelList-to-a-multi-scale-mapping"><a class="docs-heading-anchor" href="#Converting-the-ModelList-to-a-multi-scale-mapping">Converting the ModelList to a multi-scale mapping</a><a id="Converting-the-ModelList-to-a-multi-scale-mapping-1"></a><a class="docs-heading-anchor-permalink" href="#Converting-the-ModelList-to-a-multi-scale-mapping" title="Permalink"></a></h1><p>For example, let&#39;s return to the <a href="../../step_by_step/simple_model_coupling/#ModelList"><code>ModelList</code></a> coupling a light interception model, a Leaf Area Index model, and a carbon biomass increment model that was discussed in the <a href="../../step_by_step/model_switching/#Model-switching">Model switching</a> subsection: </p><pre><code class="language-julia hljs">using PlantMeteo
using PlantSimEngine
using PlantSimEngine.Examples
using CSV

meteo_day = CSV.read(joinpath(pkgdir(PlantSimEngine), &quot;examples/meteo_day.csv&quot;), DataFrame, header=18)

models_singlescale = ModelList(
    ToyLAIModel(),
    Beer(0.5),
    ToyRUEGrowthModel(0.2),
    status=(TT_cu=cumsum(meteo_day.TT),),
)

outputs_singlescale = run!(models_singlescale, meteo_day)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">TimeStepTable{Status{(:TT_cu, :LAI, :aPPFD,...}(365 x 5):
<span class="sgr31">╭─────┬──────────┬────────────┬───────────┬────────────┬───────────────────╮</span>
<span class="sgr31">│</span><span class="sgr1"> Row </span><span class="sgr31">│</span><span class="sgr1">    TT_cu </span><span class="sgr31">│</span><span class="sgr1">        LAI </span><span class="sgr31">│</span><span class="sgr1">     aPPFD </span><span class="sgr31">│</span><span class="sgr1">    biomass </span><span class="sgr31">│</span><span class="sgr1"> biomass_increment </span><span class="sgr31">│</span>
<span class="sgr31">│</span>     <span class="sgr31">│</span><span class="sgr90">  Float64 </span><span class="sgr31">│</span><span class="sgr90">    Float64 </span><span class="sgr31">│</span><span class="sgr90">   Float64 </span><span class="sgr31">│</span><span class="sgr90">    Float64 </span><span class="sgr31">│</span><span class="sgr90">           Float64 </span><span class="sgr31">│</span>
<span class="sgr31">├─────┼──────────┼────────────┼───────────┼────────────┼───────────────────┤</span>
<span class="sgr31">│</span>   1 <span class="sgr31">│</span>      0.0 <span class="sgr31">│</span> 0.00554988 <span class="sgr31">│</span> 0.0396961 <span class="sgr31">│</span> 0.00793922 <span class="sgr31">│</span>        0.00793922 <span class="sgr31">│</span>
<span class="sgr31">│</span>   2 <span class="sgr31">│</span>      0.0 <span class="sgr31">│</span> 0.00554988 <span class="sgr31">│</span>   0.02173 <span class="sgr31">│</span>  0.0122852 <span class="sgr31">│</span>          0.004346 <span class="sgr31">│</span>
<span class="sgr31">│</span>   3 <span class="sgr31">│</span>      0.0 <span class="sgr31">│</span> 0.00554988 <span class="sgr31">│</span> 0.0314899 <span class="sgr31">│</span>  0.0185832 <span class="sgr31">│</span>        0.00629798 <span class="sgr31">│</span>
<span class="sgr31">│</span>   4 <span class="sgr31">│</span>      0.0 <span class="sgr31">│</span> 0.00554988 <span class="sgr31">│</span> 0.0390834 <span class="sgr31">│</span>  0.0263999 <span class="sgr31">│</span>        0.00781668 <span class="sgr31">│</span>
<span class="sgr31">│</span>   5 <span class="sgr31">│</span>      0.0 <span class="sgr31">│</span> 0.00554988 <span class="sgr31">│</span> 0.0454514 <span class="sgr31">│</span>  0.0354902 <span class="sgr31">│</span>        0.00909028 <span class="sgr31">│</span>
<span class="sgr31">│</span>   6 <span class="sgr31">│</span>      0.0 <span class="sgr31">│</span> 0.00554988 <span class="sgr31">│</span> 0.0472677 <span class="sgr31">│</span>  0.0449437 <span class="sgr31">│</span>        0.00945354 <span class="sgr31">│</span>
<span class="sgr31">│</span>   7 <span class="sgr31">│</span>      0.0 <span class="sgr31">│</span> 0.00554988 <span class="sgr31">│</span>   0.04346 <span class="sgr31">│</span>  0.0536357 <span class="sgr31">│</span>        0.00869201 <span class="sgr31">│</span>
<span class="sgr31">│</span>   8 <span class="sgr31">│</span>      0.0 <span class="sgr31">│</span> 0.00554988 <span class="sgr31">│</span> 0.0469832 <span class="sgr31">│</span>  0.0630324 <span class="sgr31">│</span>        0.00939665 <span class="sgr31">│</span>
<span class="sgr31">│</span>   9 <span class="sgr31">│</span>      0.0 <span class="sgr31">│</span> 0.00554988 <span class="sgr31">│</span> 0.0291703 <span class="sgr31">│</span>  0.0688664 <span class="sgr31">│</span>        0.00583406 <span class="sgr31">│</span>
<span class="sgr31">│</span>  10 <span class="sgr31">│</span>      0.0 <span class="sgr31">│</span> 0.00554988 <span class="sgr31">│</span> 0.0140052 <span class="sgr31">│</span>  0.0716675 <span class="sgr31">│</span>        0.00280105 <span class="sgr31">│</span>
<span class="sgr31">│</span>  11 <span class="sgr31">│</span>      0.0 <span class="sgr31">│</span> 0.00554988 <span class="sgr31">│</span> 0.0505283 <span class="sgr31">│</span>  0.0817731 <span class="sgr31">│</span>         0.0101057 <span class="sgr31">│</span>
<span class="sgr31">│</span>  12 <span class="sgr31">│</span>      0.0 <span class="sgr31">│</span> 0.00554988 <span class="sgr31">│</span> 0.0405277 <span class="sgr31">│</span>  0.0898787 <span class="sgr31">│</span>        0.00810554 <span class="sgr31">│</span>
<span class="sgr31">│</span>  13 <span class="sgr31">│</span>   0.5625 <span class="sgr31">│</span> 0.00557831 <span class="sgr31">│</span> 0.0297814 <span class="sgr31">│</span>   0.095835 <span class="sgr31">│</span>        0.00595629 <span class="sgr31">│</span>
<span class="sgr31">│</span>  14 <span class="sgr31">│</span> 0.945833 <span class="sgr31">│</span> 0.00559777 <span class="sgr31">│</span> 0.0433269 <span class="sgr31">│</span>     0.1045 <span class="sgr31">│</span>        0.00866538 <span class="sgr31">│</span>
<span class="sgr31">│</span>  15 <span class="sgr31">│</span> 0.979167 <span class="sgr31">│</span> 0.00559946 <span class="sgr31">│</span> 0.0470271 <span class="sgr31">│</span>   0.113906 <span class="sgr31">│</span>        0.00940542 <span class="sgr31">│</span>
<span class="sgr31">│</span>  ⋮  <span class="sgr31">│</span>    ⋮     <span class="sgr31">│</span>     ⋮      <span class="sgr31">│</span>     ⋮     <span class="sgr31">│</span>     ⋮      <span class="sgr31">│</span>         ⋮         <span class="sgr31">│</span>
<span class="sgr31">╰─────┴──────────┴────────────┴───────────┴────────────┴───────────────────╯</span>
<span class="sgr36">                                                            350 rows omitted</span>
</code></pre><p>Those models all operate on a simplified model of a single plant, without any organ-local information. We can therefore consider them to be working at the &#39;whole plant&#39; scale. Their variables also operate at that &quot;plant&quot; scale, so there is no need to map any variable to other scales.</p><p>We can therefore convert this into the following mapping : </p><pre><code class="language-julia hljs">mapping = Dict(
&quot;Plant&quot; =&gt; (
   ToyLAIModel(),
    Beer(0.5),
    ToyRUEGrowthModel(0.2),
    Status(TT_cu=cumsum(meteo_day.TT),)
    ),
)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Dict{String, Tuple{PlantSimEngine.Examples.ToyLAIModel, PlantSimEngine.Examples.Beer{Float64}, PlantSimEngine.Examples.ToyRUEGrowthModel{Float64}, Status{(:TT_cu,), Tuple{Base.RefValue{Vector{Float64}}}}}} with 1 entry:
  &quot;Plant&quot; =&gt; (ToyLAIModel(8.0, 800, 110.0, 1500, 20.0), Beer{Float64}(0.5), Toy…</code></pre><p>Note the slight difference in syntax for the <a href="../../API/API_public/#PlantSimEngine.Status"><code>Status</code></a>. This is due to an implementation quirk (sorry).</p><h2 id="Adding-a-new-package-for-our-plant-graph"><a class="docs-heading-anchor" href="#Adding-a-new-package-for-our-plant-graph">Adding a new package for our plant graph</a><a id="Adding-a-new-package-for-our-plant-graph-1"></a><a class="docs-heading-anchor-permalink" href="#Adding-a-new-package-for-our-plant-graph" title="Permalink"></a></h2><p>None of these models operate on a multi-scale tree graph, either. There is no concept of organ creation or growth. We still need to provide a multi-scale tree graph to a multi-scale simulation, so we can -for now- declare a very simple MTG, with a single node:</p><pre><code class="language-julia hljs">using MultiScaleTreeGraph

mtg = MultiScaleTreeGraph.Node(MultiScaleTreeGraph.NodeMTG(&quot;/&quot;, &quot;Plant&quot;, 0, 0),)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">/ 1: Plant
</code></pre><div class="admonition is-info" id="Note-c6deb4dbe60570e6"><header class="admonition-header">Note<a class="admonition-anchor" href="#Note-c6deb4dbe60570e6" title="Permalink"></a></header><div class="admonition-body"><p>You will need to add the <code>MultiScaleTreeGraph</code> package to your environment. See <a href="../../prerequisites/installing_plantsimengine/#Installing-and-running-PlantSimEngine">Installing and running PlantSimEngine</a> if you are not yet comfortable with Julia or need a refresher.</p></div></div><h2 id="Running-the-multi-scale-simulation-?"><a class="docs-heading-anchor" href="#Running-the-multi-scale-simulation-?">Running the multi-scale simulation ?</a><a id="Running-the-multi-scale-simulation-?-1"></a><a class="docs-heading-anchor-permalink" href="#Running-the-multi-scale-simulation-?" title="Permalink"></a></h2><p>We now have <strong>almost</strong> everything we need to run the multiscale simulation.</p><p>This first conversion step can be a starting point for a more elaborate multi-scale simulation. </p><p>The signature of the <a href="../../API/API_public/#PlantSimEngine.run!"><code>run!</code></a> function in multi-scale differs slightly from the ModelList version : </p><pre><code class="language-julia hljs">out_multiscale = run!(mtg, mapping, meteo_day)</code></pre><p>(Some of the optional arguments also change slightly)</p><p>Unfortunately, there is one caveat. Passing in a vector through the <a href="../../API/API_public/#PlantSimEngine.Status"><code>Status</code></a> field is still possible in multi-scale mode, but requires a little more advanced tinkering with the mapping, as it generates a custom model under the hood and the implementation is experimental and less user-friendly.</p><p>If you are keen on going down that path, you can find a detailed example <a href="../../troubleshooting_and_testing/tips_and_workarounds/#multiscale_vector">here</a>, but we don&#39;t recommend it for beginners.</p><p>What we&#39;ll do instead, is write our own model provide the thermal time per timestep as a variable, instead of as a single vector in the <a href="../../API/API_public/#PlantSimEngine.Status"><code>Status</code></a>.</p><p>Our &#39;pseudo-multiscale&#39; first approach will therefore turn into a genuine multi-scale simulation.</p><h2 id="Adding-a-second-scale"><a class="docs-heading-anchor" href="#Adding-a-second-scale">Adding a second scale</a><a id="Adding-a-second-scale-1"></a><a class="docs-heading-anchor-permalink" href="#Adding-a-second-scale" title="Permalink"></a></h2><p>Let&#39;s have a model provide the Cumulated Thermal Time to our Leaf Area Index model, instead of initializing it through the <a href="../../API/API_public/#PlantSimEngine.Status"><code>Status</code></a>. </p><p>Let&#39;s instead implement our own <code>ToyTT_cuModel</code>.</p><h3 id="TT_cu-model-implementation"><a class="docs-heading-anchor" href="#TT_cu-model-implementation">TT_cu model implementation</a><a id="TT_cu-model-implementation-1"></a><a class="docs-heading-anchor-permalink" href="#TT_cu-model-implementation" title="Permalink"></a></h3><p>This model doesn&#39;t require any outside data or input variables, it only operates on the weather data and outputs our desired TT_cu. The implementation doesn&#39;t require any advanced coupling and is very straightforward.</p><pre><code class="language-julia hljs">PlantSimEngine.@process &quot;tt_cu&quot; verbose = false

struct ToyTt_CuModel &lt;: AbstractTt_CuModel
end

function PlantSimEngine.run!(::ToyTt_CuModel, models, status, meteo, constants, extra=nothing)
    status.TT_cu +=
        meteo.TT
end

function PlantSimEngine.inputs_(::ToyTt_CuModel)
    NamedTuple() # No input variables
end

function PlantSimEngine.outputs_(::ToyTt_CuModel)
    (TT_cu=0.0,)
end</code></pre><div class="admonition is-info" id="Note-459eb2bfa9807029"><header class="admonition-header">Note<a class="admonition-anchor" href="#Note-459eb2bfa9807029" title="Permalink"></a></header><div class="admonition-body"><p>The only accessible variables in the <a href="../../API/API_public/#PlantSimEngine.run!"><code>run!</code></a> function via the status are the ones that are local to the &quot;Scene&quot; scale. This isn&#39;t explicit at first glance, but very important to keep in mind when developing models, or using them at different scales. If variables from other scales are required, then they need to be mapped via a <a href="../../API/API_public/#PlantSimEngine.MultiScaleModel"><code>MultiScaleModel</code></a>, or sometimes a more complex coupling is necessary.</p></div></div><h3 id="Linking-the-new-TT_cu-model-to-a-scale-in-the-mapping"><a class="docs-heading-anchor" href="#Linking-the-new-TT_cu-model-to-a-scale-in-the-mapping">Linking the new TT_cu model to a scale in the mapping</a><a id="Linking-the-new-TT_cu-model-to-a-scale-in-the-mapping-1"></a><a class="docs-heading-anchor-permalink" href="#Linking-the-new-TT_cu-model-to-a-scale-in-the-mapping" title="Permalink"></a></h3><p>We now have our model implementation. How does it fit into our mapping ?</p><p>Our new model doesn&#39;t really relate to a specific organ of our plant. In fact, this model doesn&#39;t represent a physiological process of the plant, but rather an environmental process affecting its physiology. We could therefore have it operate at a different scale unrelated to the plant, which we&#39;ll call &quot;Scene&quot;. This makes sense.</p><p>Note that we now need to add a &quot;Scene&quot; node to our Multi-scale Tree Graph, otherwise our model will not run, since no other model calls it and &quot;Plant&quot; nodes will only call models at the &quot;Plant&quot; scale. See <a href="../../troubleshooting_and_testing/plantsimengine_and_julia_troubleshooting/#Empty-status-vectors-in-multi-scale-simulations">Empty status vectors in multi-scale simulations</a> for more details.</p><pre><code class="language-julia hljs">mtg_multiscale = MultiScaleTreeGraph.Node(MultiScaleTreeGraph.NodeMTG(&quot;/&quot;, &quot;Scene&quot;, 0, 0),)
    plant = MultiScaleTreeGraph.Node(mtg_multiscale, MultiScaleTreeGraph.NodeMTG(&quot;+&quot;, &quot;Plant&quot;, 1, 1))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">+ 2: Plant
</code></pre><h3 id="Mapping-between-scales-:-the-MultiScaleModel-wrapper"><a class="docs-heading-anchor" href="#Mapping-between-scales-:-the-MultiScaleModel-wrapper">Mapping between scales : the MultiScaleModel wrapper</a><a id="Mapping-between-scales-:-the-MultiScaleModel-wrapper-1"></a><a class="docs-heading-anchor-permalink" href="#Mapping-between-scales-:-the-MultiScaleModel-wrapper" title="Permalink"></a></h3><p>The cumulated thermal time (<code>:TT_cu</code>) which was previously provided to the LAI model as a simulation parameter now needs to be mapped from the &quot;Scene&quot; scale level. </p><p>This is done by wrapping our ToyLAIModel in a dedicated structure called a <a href="../../API/API_public/#PlantSimEngine.MultiScaleModel"><code>MultiScaleModel</code></a>. A <a href="../../API/API_public/#PlantSimEngine.MultiScaleModel"><code>MultiScaleModel</code></a> requires two keyword arguments : <code>model</code>, indicating the model for which some variables are mapped, and <code>mapped_variables</code>, indicating which scale link to which variables, and potentially renaming them.</p><p>There can be different kinds of variable mapping with slightly different syntax, but in our case, only a single scalar value of the TT_cu is passed from the &quot;Scene&quot; to the &quot;Plant&quot; scale.</p><p>This gives us the following declaration with the <a href="../../API/API_public/#PlantSimEngine.MultiScaleModel"><code>MultiScaleModel</code></a> wrapper for our LAI model: </p><pre><code class="language-julia hljs">MultiScaleModel(
            model=ToyLAIModel(),
            mapped_variables=[
                :TT_cu =&gt; &quot;Scene&quot;,
            ],
        )</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">MultiScaleModel{PlantSimEngine.Examples.ToyLAIModel, Vector{Pair{Union{Symbol, PreviousTimeStep}, Union{Pair{String, Symbol}, Vector{Pair{String, Symbol}}}}}}(PlantSimEngine.Examples.ToyLAIModel(8.0, 800, 110.0, 1500, 20.0), Pair{Union{Symbol, PreviousTimeStep}, Union{Pair{String, Symbol}, Vector{Pair{String, Symbol}}}}[:TT_cu =&gt; (&quot;Scene&quot; =&gt; :TT_cu)])</code></pre><p>and the new mapping with two scales:</p><pre><code class="language-julia hljs">mapping_multiscale = Dict(
    &quot;Scene&quot; =&gt; ToyTt_CuModel(),
    &quot;Plant&quot; =&gt; (
        MultiScaleModel(
            model=ToyLAIModel(),
            mapped_variables=[
                :TT_cu =&gt; &quot;Scene&quot;,
            ],
        ),
        Beer(0.5),
        ToyRUEGrowthModel(0.2),
    ),
)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Dict{String, Any} with 2 entries:
  &quot;Scene&quot; =&gt; ToyTt_CuModel()
  &quot;Plant&quot; =&gt; (MultiScaleModel{ToyLAIModel, Vector{Pair{Union{Symbol, PreviousTi…</code></pre><h3 id="Running-the-multi-scale-simulation"><a class="docs-heading-anchor" href="#Running-the-multi-scale-simulation">Running the multi-scale simulation</a><a id="Running-the-multi-scale-simulation-1"></a><a class="docs-heading-anchor-permalink" href="#Running-the-multi-scale-simulation" title="Permalink"></a></h3><p>We can then run the multiscale simulation, with our two-node MTG :</p><pre><code class="language-julia hljs">outputs_multiscale = run!(mtg_multiscale, mapping_multiscale, meteo_day)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Dict{String, Vector} with 2 entries:
  &quot;Scene&quot; =&gt; Status{(:timestep, :node, :TT_cu), Tuple{RefValue{Int64}, RefValue…
  &quot;Plant&quot; =&gt; Status{(:timestep, :node, :TT_cu, :biomass_increment, :aPPFD, :LAI…</code></pre><h3 id="Comparing-outputs-between-single-and-multi-scale"><a class="docs-heading-anchor" href="#Comparing-outputs-between-single-and-multi-scale">Comparing outputs between single- and multi-scale</a><a id="Comparing-outputs-between-single-and-multi-scale-1"></a><a class="docs-heading-anchor-permalink" href="#Comparing-outputs-between-single-and-multi-scale" title="Permalink"></a></h3><p>The outputs structures are slightly different : multi-scale outputs are indexed by scale, and a variable has a value for every node of the scale it operates at (for instance, there would be a &quot;leaf_surface&quot; value for every leaf in a plant), stored in an array.</p><p>In our simple example, we only have one MTG scene node and one plant node, so the arrays for each variable in the multi-scale output only contain one value.</p><p>We can access the output variables at the &quot;Scene&quot; scale by indexing our outputs:</p><pre><code class="language-julia hljs">outputs_multiscale[&quot;Scene&quot;]</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">365-element Vector{Status{(:timestep, :node, :TT_cu), Tuple{Base.RefValue{Int64}, Base.RefValue{MultiScaleTreeGraph.Node{MultiScaleTreeGraph.NodeMTG, Dict{Symbol, Any}}}, Base.RefValue{Float64}}}}:
 Status(timestep = 1, node = / 1: Scene
└─ + 2: Plant
, TT_cu = 0.0)
 Status(timestep = 2, node = / 1: Scene
└─ + 2: Plant
, TT_cu = 0.0)
 Status(timestep = 3, node = / 1: Scene
└─ + 2: Plant
, TT_cu = 0.0)
 Status(timestep = 4, node = / 1: Scene
└─ + 2: Plant
, TT_cu = 0.0)
 Status(timestep = 5, node = / 1: Scene
└─ + 2: Plant
, TT_cu = 0.0)
 Status(timestep = 6, node = / 1: Scene
└─ + 2: Plant
, TT_cu = 0.0)
 Status(timestep = 7, node = / 1: Scene
└─ + 2: Plant
, TT_cu = 0.0)
 Status(timestep = 8, node = / 1: Scene
└─ + 2: Plant
, TT_cu = 0.0)
 Status(timestep = 9, node = / 1: Scene
└─ + 2: Plant
, TT_cu = 0.0)
 Status(timestep = 10, node = / 1: Scene
└─ + 2: Plant
, TT_cu = 0.0)
 ⋮
 Status(timestep = 357, node = / 1: Scene
└─ + 2: Plant
, TT_cu = 2177.904166666665)
 Status(timestep = 358, node = / 1: Scene
└─ + 2: Plant
, TT_cu = 2178.4249999999984)
 Status(timestep = 359, node = / 1: Scene
└─ + 2: Plant
, TT_cu = 2179.729166666665)
 Status(timestep = 360, node = / 1: Scene
└─ + 2: Plant
, TT_cu = 2180.4749999999985)
 Status(timestep = 361, node = / 1: Scene
└─ + 2: Plant
, TT_cu = 2181.1458333333317)
 Status(timestep = 362, node = / 1: Scene
└─ + 2: Plant
, TT_cu = 2183.941666666665)
 Status(timestep = 363, node = / 1: Scene
└─ + 2: Plant
, TT_cu = 2189.2666666666646)
 Status(timestep = 364, node = / 1: Scene
└─ + 2: Plant
, TT_cu = 2192.895833333331)
 Status(timestep = 365, node = / 1: Scene
└─ + 2: Plant
, TT_cu = 2193.8166666666643)</code></pre><p>We have a <code>Vector{NamedTuple}</code>structure. Our single-scale output is a <code>Vector{T}</code>:</p><pre><code class="language-julia hljs">outputs_singlescale.TT_cu</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">365-element Vector{Float64}:
    0.0
    0.0
    0.0
    0.0
    0.0
    0.0
    0.0
    0.0
    0.0
    0.0
    ⋮
 2177.9041666666662
 2178.4249999999997
 2179.729166666666
 2180.4749999999995
 2181.145833333333
 2183.941666666666
 2189.2666666666664
 2192.895833333333
 2193.816666666666</code></pre><p>Let&#39;s extract the multi-scale <code>:TT_cu</code>:</p><pre><code class="language-julia hljs">computed_TT_cu_multiscale = [outputs_multiscale[&quot;Scene&quot;][i].TT_cu for i in 1:length(outputs_multiscale[&quot;Scene&quot;])]</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">365-element Vector{Float64}:
    0.0
    0.0
    0.0
    0.0
    0.0
    0.0
    0.0
    0.0
    0.0
    0.0
    ⋮
 2177.904166666665
 2178.4249999999984
 2179.729166666665
 2180.4749999999985
 2181.1458333333317
 2183.941666666665
 2189.2666666666646
 2192.895833333331
 2193.8166666666643</code></pre><p>We can now compare them value-by-value and do a piecewise approximate equality test :</p><pre><code class="language-julia hljs">for i in 1:length(computed_TT_cu_multiscale)
    if !(computed_TT_cu_multiscale[i] ≈ outputs_singlescale.TT_cu[i])
        println(i)
    end
end</code></pre><p>or equivalently, with broadcasting, we can write :</p><pre><code class="language-julia hljs">is_approx_equal = length(unique(computed_TT_cu_multiscale .≈ outputs_singlescale.TT_cu)) == 1</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">true</code></pre><div class="admonition is-info" id="Note-6a4a553fc542d0e0"><header class="admonition-header">Note<a class="admonition-anchor" href="#Note-6a4a553fc542d0e0" title="Permalink"></a></header><div class="admonition-body"><p>You may be wondering why we check for approximate equality rather than strict equality. The reason for that is due to floating-point accumulation errors, which are discussed in more detail in <a href="../../working_with_data/floating_point_accumulation_error/#Floating-point-considerations">Floating-point considerations</a>.</p></div></div><h2 id="ToyDegreeDaysCumulModel"><a class="docs-heading-anchor" href="#ToyDegreeDaysCumulModel">ToyDegreeDaysCumulModel</a><a id="ToyDegreeDaysCumulModel-1"></a><a class="docs-heading-anchor-permalink" href="#ToyDegreeDaysCumulModel" title="Permalink"></a></h2><p>There is a model able to provide Thermal Time based on weather temperature data, <a href="#ToyDegreeDaysCumulModel"><code>ToyDegreeDaysCumulModel</code></a>, which can also be found in the examples folder. </p><p>We didn&#39;t make use of it here for learning purposes. It also computes a thermal time based on default parameters that don&#39;t correspond to the thermal time in the example weather data, so results differ from the thermal time already present in the weather data without tinkering with the parameters. </p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../multiscale_considerations/">« Multiscale considerations</a><a class="docs-footer-nextpage" href="../multiscale/">More variable mapping examples »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.14.1 on <span class="colophon-date" title="Wednesday 24 September 2025 07:21">Wednesday 24 September 2025</span>. Using Julia version 1.11.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
